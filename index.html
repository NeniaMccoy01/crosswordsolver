<!DOCTYPE html>

<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Get word recommendations based on clues and known letters to help you solve your next crossword puzzle.">

        <title>Crossword Solver</title>

        <link rel="shortcut icon" href="assets/images/favicon.png">
        <link href="//fonts.googleapis.com/css2?family=Old+Standard+TT:wght@700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="assets/css/style.css">
    </head>

    <body>
        <main>
            <header>
                <div class="wrap">
                    <h1><a href="index.html">Crossword Puzzle Solver</a></h1>

                    <p>Get word recommendations based on given clues and known letters to help you solve your next crossword puzzle.</p>

                    <form id="add-clues" method="get" action="?">
                        <p>
                            <label for="clue">Given Clue</label>
                            <input type="text" name="ml" id="clue" placeholder="e.g. unstated yet understood" required>
                        </p>

                        <p>
                            <label for="word">Known Letters</label>
                            <input type="text" name="sp" id="word" placeholder="ta??t (? for unknown)">
                        </p>

                        <button>Find Words</button>
                    </form>
                </div>
            </header>

            <div id="app"></div>
        </main>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>
        <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
        <script>
            const router = new VueRouter({
                mode: 'history',
                routes: []
            });

            new Vue({
                router,
                el: '#app',
                data() {
                    return {
                        info: null,
                        loading: true,
                        errored: false
                    }
                },
                mounted() {
                    /**
                     * Sanitize and encode all HTML in a string to prevent XSS attacks.
                     * link: https://vanillajstoolkit.com/helpers/sanitizehtml/
                     * param  {String} str The user-submitted string.
                     * return {String} str The sanitized string.
                     */
                    const sanitizeHTML = function (string) {
                        const temp = document.createElement('div');
                        temp.textContent = string;
                        return temp.innerHTML;
                    };

                    // Update the DOM when the API is down.
                    const renderNoResults = () => {
                        this.$el.innerHTML = `
                            <section id="results" class="word-list wrap">
                                <h2>Sorry, No Results</h2>
                                <p>We\'re not able to retrieve any words that match the provided clues, please try again.</p>
                            </section>
                        `;
                    };

                    // Update the DOM when the API call is successful.
                    const renderResults = results => {
                        // If there's no results, display a message.
                        if (results.length < 1) {
                            renderNoResults();
                            return;
                        }

                        // Define the list items.
                        const wordList = results.map(result => {
                            if (result.defs) {
                                return `
                                    <li>
                                        <details>
                                            <summary>${sanitizeHTML(result.word)}</summary>
                                            <p>${sanitizeHTML(result.defs.join('; '))}</p>
                                        </details>
                                    </li>
                                `;
                            } else {
                                return `<li>${sanitizeHTML(result.word)}</li>`;
                            }
                        }).join('');

                        const wordCount = this.$route.query.sp.length > 0 ? this.$route.query.sp.length + ' letter word' : 'No word specified';

                        // Update the DOM.
                        this.$el.innerHTML = `
                        <section id="results" class="word-list wrap">
                            <h2>Word Suggestions</h2>
                            <p class="clue"><span>Clue:</span> ${this.$route.query.ml.split('+').join(' ')}</p>
                            <p class="word">${wordCount}</p>
                            <ol>${wordList}</ol>
                        </section>
                        `;

                        // Auto scroll to results section.
                        const anchor = document.querySelector('#results');
                        anchor.scrollIntoView();
                    }

                    if (this.$route.query.ml || this.$route.query.sp) {
                        const api = 'https://api.datamuse.com/words?ml=' + this.$route.query.ml + '&sp=' + this.$route.query.sp + '&md=d&max=20';

                        axios.get(api).then(response => {
                            // Add the response data from the API call into the info object.
                            this.info = response.data;

                            // Render the data into the DOM.
                            renderResults(this.info);
                        }).catch(error => {
                            // If there's an error, log it.
                            console.warn(error);

                            // Display error message.
                            this.$el.innerHTML = `
                                <section id="results" class="word-list wrap">
                                    <h2>There was an Error</h2>
                                    <p>We\'re not able to retrieve this information at the moment, please try again later.</p>
                                </section>
                            `;
                        }).finally(() => {
                            this.loading = false;
                        });
                    }
                }
            });
        </script>
    </body>

</html>
